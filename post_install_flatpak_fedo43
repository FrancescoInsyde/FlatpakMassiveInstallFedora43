#!/bin/bash
#
# Script d'Installation AutomatisÃ©e des Applications Flatpak (Fedora 43)
# Auteur : Franck Bailliet & AI Perplexity
# Licence : GNU General Public License v3.0
# Date : 2025-12-02
#
# Ce script installe automatiquement toutes les applications Flatpak disponibles
# depuis Flathub en contournant les limitations spÃ©cifiques Ã  Fedora 43.
#
# AVERTISSEMENT : Installation massive ! Plusieurs Go d'espace requis.

# === CONFIGURATION ===
FLATHUB_REPO="https://flathub.org/repo/flathub.flatpakrepo"

# === FONCTIONS ===
update_metadata() {
    echo "ðŸ“¡ Mise Ã  jour des mÃ©tadonnÃ©es AppStream..."
    flatpak remote-add --if-not-exists flathub "$FLATHUB_REPO"
    flatpak update --appstream
    flatpak repair
}

extract_app_ids() {
    # MÃ©thode ultra-robuste : extraction des vrais IDs Flatpak depuis search *
    flatpak search "*" | \
    grep -oE '[a-z][a-z0-9]*\.[a-z][a-z0-9]*(\.[a-z][a-z0-9]*)+' | \
    grep -v '\.$' | \
    sort | uniq
}

install_app() {
    local app_id="$1"
    echo "ðŸ“¦ Installation de $app_id ..."
    printf '0\ny\ny\ny\n' | flatpak install -y flathub "$app_id" 2>/dev/null || \
    echo "âš ï¸  Erreur sur $app_id, continuation..."
}

show_stats() {
    echo "=== ðŸ“Š STATISTIQUES FINALES ==="
    echo "Apps installÃ©es : $(flatpak list --app | wc -l)"
    echo "Espace utilisÃ© :"
    du -sh /var/lib/flatpak/ 2>/dev/null || echo "var/lib/flatpak : ?"
    du -sh ~/.local/share/flatpak/ 2>/dev/null || echo "~/.local/share/flatpak : ?"
}

# === SCRIPT PRINCIPAL ===
echo "ðŸš€ Flatpak Mass Install - Fedora 43 Edition"
echo "=========================================="

update_metadata

apps=$(extract_app_ids)
app_count=$(echo "$apps" | wc -l)

echo "ðŸ“‹ $(echo "$apps" | wc -l) applications trouvÃ©es"
echo "Exemples : $(echo "$apps" | head -5 | tr '\n' ' ')..."
echo

total=$(echo "$apps" | wc -l)
counter=0

for app in $apps; do
    ((counter++))
    echo "[$counter/$total] $(install_app "$app")"
done

show_stats
echo "âœ… Installation terminÃ©e !"
echo ""
echo "Pour lancer une app : flatpak run com.exemple.App"
echo "Pour lister : flatpak list --app"
